---
title: "Meninges Report"
params:
    str: "APP"
editor: visual
toc: true
---

```{r}
#| label: setup
#| include: FALSE
library(ggplot2)
library(patchwork)
library(dplyr)
library(png)
library(grid)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE,
                      fig.path = paste0("results/plots/", params$str))
```

## Overview

In this report we profile the meninges of `r params$str` mice in terms of Tertiary Lymphatic Structures (TLSs). The following chapters provide insight to different aspects of the TLSs, such as their location, distribution and density.

```{r}
#| label: data
figure <- readPNG("data/opac_meninges.png")
df <- read.csv("data/processed_data.csv")

outlier_threshold <- 13
levs <- c("F.young", "F.middle", "F.old",
          "M.young", "M.middle", "M.old")

df <- df %>%
  filter(Strain == params$str, Y < outlier_threshold) %>%
  mutate(Phenotype = as.factor(Phenotype),
         Age = factor(Age, c("young", "middle", "old")),
         Sex.Age = factor(interaction(Sex, Age, sep = "."), levs))
```

```{r}
#| label: constants
asp_ratio <- 0.92
meninges_height <- 10.1
meninges_bottom <- meninges_height / 4
meninges_width <- (meninges_height + meninges_bottom) * asp_ratio / 2

upper_lim <- max(meninges_height, max(df$Y[df$Y < outlier_threshold]))
side_lim <- max(meninges_width, max(abs(df$X)))
lower_lim <- min(-meninges_bottom, min(df$Y))
```

## Exploratory statistics

The current analysis includes data on `r nrow(df)` lymphatic structures from `r n_distinct(df$TissueID)` mice, belonging to `r n_distinct(df$Strain)` strains, `r n_distinct(df$Age)` age categories and `r n_distinct(df$Sex)` genders, for a total of `r n_distinct(interaction(df$Strain, df$Age, df$Sex))` groups (@tbl-stats).

```{r}
#| label: tbl-stats
#| tbl-cap: Basic statistics on the TLSs from mice meninges. Size and length are measured in mm, whereas phenotype and sinus location are reported in terms of the number of structures per each phenotype or sinus location, respectively.
df %>%
  group_by(Sex, Age) %>%
  summarise(Mice = n_distinct(TissueID),
            Structures = n(),
            MeanSize = round(mean(Size), 1),
            MeanLength = round(mean(Length), 1),
            `Phenotype (1-2-3)` = paste(sum(Phenotype == 1), sum(Phenotype == 2), sum(Phenotype == 3), sep = "-"),
            `Sinus (0-90-180)` = paste(sum(Sinus == 0), sum(Sinus == 90), sum(Sinus == 180), sep = "-")) %>%
  knitr::kable()
```

@fig-bar shows the distribution the TLSs distribute in terms of their length and size across all tissues.

```{r}
#| label: fig-bar
#| fig-cap: Barplots of tertiary lyphatic structures distributed by (A) length and (B) size in mm.
p1 <- ggplot(df, aes(x = Length)) +
  geom_histogram(bins = 50) +
  labs(x = "Length in mm", y = "TLS Count") +
  theme_classic()

p2 <- ggplot(df, aes(x = Size)) +
  geom_histogram(bins = 50) +
  labs(x = "Size in mm", y = "TLS Count") +
  theme_classic()

p1 / p2 +
  plot_annotation(tag_levels = "A")
```

## Location of structures

```{r}
#| label: params
my_alpha <- 2/3
my_label_threshold <- max(df$Size) + 1
my_label_size <- 2
my_label_colour <- "black"
```

```{r}
#| label: fig-loc
#| fig-cap: Scatter plot of TLSs around meninges. Each dot represents one structure, sized by dimension, coloured by phenotype and labeled by sample. Each panel corresponds to a mice group based on sex and age category.
#| fig-width: !expr 3.5 * n_distinct(df$Age)
#| fig-height: !expr 3.5 * n_distinct(df$Sex)
ggplot(df, aes(x = X, y = Y, colour = Phenotype, size = Size)) +
  lims(x = c(-side_lim, side_lim), y = c(lower_lim, upper_lim)) +
  annotation_custom(rasterGrob(figure, 
                               width = unit(1, "npc"), 
                               height = unit(1, "npc")), 
                    -meninges_width, meninges_width,
                    -meninges_bottom, meninges_height) +
  geom_point(alpha = my_alpha) +
  labs(x = "X in mm", y = "Y in mm") +
  facet_grid(Sex ~ Age) +
  theme_classic()
```

## Distribution of structures

```{r}
my_low <- "white"
my_high <- "red"
```

```{r}
#| label: fig-dist
#| fig-cap: 2d Binned plot of tertiary limphatic structures around meninges. Colour indicates number of structures found in each hexagonal cell. Each panel corresponds to a mice group based on sex and age category.
#| fig-width: !expr 3.5 * n_distinct(df$Age)
#| fig-height: !expr 3.5 * n_distinct(df$Sex)
ggplot(df, aes(x = X, y = Y)) +
  lims(x = c(-side_lim, side_lim), y = c(lower_lim, upper_lim)) +
  annotation_custom(rasterGrob(figure, 
                               width = unit(1, "npc"), 
                               height = unit(1, "npc")), 
                    -meninges_width, meninges_width,
                    -meninges_bottom, meninges_height) +
  geom_hex() +
  scale_fill_gradient2(low = my_low, high = my_high) +
  labs(x = "X in mm", y = "Y in mm") +
  facet_grid(Sex ~ Age) +
  theme_classic()
```

### Distribution by phenotype

```{r}
#| label: fig-dist-pheno
#| fig-cap: 2d Binned plot of tertiary limphatic structures around meninges by phenotype (1, 2 or 3). Colour indicates number of structures found in each hexagonal cell. Rows correspond to a mice group based on sex and age category, whereas columns represent phenotypes.
#| fig-width: 10
#| fig-height: !expr 3 * n_distinct(df$Sex.Age)
ggplot(df, aes(x = X, y = Y)) +
  lims(x = c(-side_lim, side_lim), y = c(lower_lim, upper_lim)) +
  annotation_custom(rasterGrob(figure, 
                               width = unit(1, "npc"), 
                               height = unit(1, "npc")), 
                    -meninges_width, meninges_width,
                    -meninges_bottom, meninges_height) +
  geom_hex() +
  scale_fill_gradient2(low = my_low, high = my_high) +
  labs(x = "X in mm", y = "Y in mm", fill = "Count") +
  facet_grid(Sex.Age ~ Phenotype) +
  theme_classic()
```

## Density of structures

@fig-dens shows the density of TLSs.

```{r}
my_palette <- 8
my_dir <- 1
```

```{r}
#| label: fig-dens
#| fig-cap: Density plot of TLSs around meninges. Colour indicates the fraction of structures found in each pixel. Each panel corresponds to a mice group based on sex and age category.
#| fig-width: !expr 3.5 * n_distinct(df$Age)
#| fig-height: !expr 3.5 * n_distinct(df$Sex)
ggplot(df, aes(x = X, y = Y)) +
  lims(x = c(-side_lim, side_lim), y = c(lower_lim, upper_lim)) +
  stat_density2d(aes(fill = after_stat(ndensity)),
                 geom = "raster", contour = FALSE) +
  annotation_custom(rasterGrob(figure, 
                               width = unit(1, "npc"), 
                               height = unit(1, "npc")), 
                    -meninges_width, meninges_width,
                    -meninges_bottom, meninges_height) +
  scale_fill_distiller(palette = my_palette, direction = my_dir) +
  labs(x = "X in mm", y = "Y in mm", fill = "Density") +
  facet_grid(Sex ~ Age) +
  theme_bw()
```

```{r}
#| label: fig-loc-dens
#| fig-cap: Density plot of TLSs around meninges. Each dot represents one structure, sized by dimension, coloured by phenotype. Colour indicates the fraction of structures found in each pixel. Each panel corresponds to a mice group based on sex and age category.
#| fig-width: !expr 3.5 * n_distinct(df$Age)
#| fig-height: !expr 3.5 * n_distinct(df$Sex)
ggplot(df, aes(x = X, y = Y)) +
  lims(x = c(-side_lim, side_lim), y = c(lower_lim, upper_lim)) +
  stat_density2d(aes(fill = after_stat(ndensity)),
                 geom = "raster", contour = FALSE) +
  annotation_custom(rasterGrob(figure, 
                               width = unit(1, "npc"), 
                               height = unit(1, "npc")), 
                    -meninges_width, meninges_width,
                    -meninges_bottom, meninges_height) +
  geom_point(aes(colour = Phenotype, size = Size), alpha = my_alpha) +
  scale_fill_distiller(palette = 6, direction = my_dir) +
  labs(x = "X in mm", y = "Y in mm", fill = "Density") +
  facet_grid(Sex ~ Age) +
  theme_bw()
```

### Density by phenotype

```{r}
#| label: fig-dens-pheno
#| fig-cap: Density plot of tertiary lymphatic structures around meninges by phenotype (1, 2 or 3). Colour indicates the fraction of structures found in each pixel. Rows correspond to a mice group based on sex and age category, whereas columns represent phenotypes.
#| fig-width: 10
#| fig-height: !expr 3 * n_distinct(df$Sex.Age)
ggplot(df, aes(x = X, y = Y)) +
  lims(x = c(-side_lim, side_lim), y = c(lower_lim, upper_lim)) +
  stat_density2d(aes(fill = after_stat(ndensity)),
                 geom = "raster", contour = FALSE) +
  annotation_custom(rasterGrob(figure, 
                               width = unit(1, "npc"), 
                               height = unit(1, "npc")), 
                    -meninges_width, meninges_width,
                    -meninges_bottom, meninges_height) +
  scale_fill_distiller(palette = my_palette, direction = my_dir) +
  labs(x = "X in mm", y = "Y in mm", fill = "Density") +
  facet_grid(Sex.Age ~ Phenotype) +
  theme_bw()
```
